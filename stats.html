<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8" />
    <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠ - Ù…Ø¬Ù…Ø¹ Ø§Ø·Ù„Ø³ Ø§Ù„Ø·Ø¨ÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --brand: #0066cc;
            --text: #222;
            --card: #fff;
            --muted: #666;
            --border: #e6e6e6;
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Tahoma, sans-serif;
            direction: rtl;
            background: #f7f7f793;
            color: var(--text);
            margin: 0
        }

        header {
            background: var(--card);
            border-bottom: 1px solid var(--border)
        }

        .topbar {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 14px 20px
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .brand img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            border-radius: 8px
        }

        .brand h1 {
            margin: 0;
            font-size: 30px;
            color: var(--brand);
            font-weight: bold
        }

        .meta {
            flex: 1;
            text-align: left
        }

        #today {
            margin: 0;
            color: var(--muted)
        }

        .actions {
            display: flex;
            gap: 8px
        }

        .btn {
            padding: 9px 14px;
            border: none;
            border-radius: 8px;
            background: var(--brand);
            color: #fff;
            cursor: pointer;
            font-size: 14px
        }

        .btn.secondary {
            background: #12a150
        }

        .page {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 16px;
            display: grid;
            grid-template-columns: repeat(2, minmax(320px, 1fr));
            gap: 20px
        }

        @media (max-width:900px) {
            .page {
                grid-template-columns: 1fr
            }

            .meta {
                display: none
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .05);
            padding: 18px
        }

        .card h2 {
            margin: 0 0 10px;
            font-size: 18px;
            color: var(--brand)
        }

        .chart-box {
            height: 360px
        }

        @media (max-width:600px) {
            .chart-box {
                height: 280px
            }
        }

        canvas {
            width: 100% !important;
            height: 100% !important
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 10px;
            text-align: center
        }

        thead th {
            background: #f3f6fb
        }

        /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        #deptTable th,
        #deptTable td {
            text-align: center;
            padding: 10px;
        }

        #deptTable thead th {
            background: #f3f6fb;
        }

        #deptTable tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .notice {
            background: #fff7e6;
            border: 1px solid #ffd195;
            color: #7a4a00;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            text-align: center
        }

        .capturing .no-print {
            display: none !important
        }

        @media print {
            body {
                width: 210mm;
                height: 297mm;
                margin: 10mm;
                background: #fff;
                font-size: 12px
            }

            header {
                background: #fff !important;
                color: #000 !important;
                border-bottom: 1px solid #ccc
            }

            .brand h1 {
                color: #000 !important
            }

            .brand img {
                width: 60px;
                height: 60px;
                object-fit: contain;
            }

            #today {
                color: #000 !important
            }

            .page {
                display: block
            }

            .card {
                page-break-inside: avoid;
                margin-bottom: 14px;
                box-shadow: none
            }

            .no-print,
            button {
                display: none !important
            }
        }
    </style>
</head>

<body>

    <div id="printArea">
        <header>
            <div class="topbar">
                <div class="brand">
                    <img src="logo.jpg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰">
                    <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠ</h1>
                </div>
                <div class="meta">
                    <p id="today"></p>
                </div>
                <div class="actions no-print">
                    <button class="btn" onclick="window.print()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
                    <button class="btn secondary" onclick="exportPDF(event)">â¬‡ PDF</button>
                </div>
            </div>
        </header>

        <main class="page">
            <!-- 1) Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø± -->
            <section class="card">
                <h2>ğŸ“… Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</h2>
                <div class="chart-box"><canvas id="monthlyChart"></canvas></div>
                <p id="monthlyTotal" style="text-align:center; margin-top:10px"></p>
            </section>

            <!-- 2) ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
            <section class="card">
                <h2>ğŸ¥ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
                <div class="chart-box"><canvas id="deptChart"></canvas></div>
                <p id="deptTop" style="text-align:center; margin-top:10px"></p>

                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ÙŠÙ…ØªÙ„Ø¦ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø´ÙŠØª) -->
                <table id="deptTable" style="margin-top:12px;">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù‚Ø³Ù…</th>
                            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th> <!-- Ø²ÙŠØ§Ø±Ø§Øª Ø£Ùˆ Ù†Ø³Ø¨Ø© % Ø­Ø³Ø¨ Ø§Ù„Ù…ØªÙˆÙØ± -->
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <!-- 3) Ø¬Ø¯ÙˆÙ„ Ù…Ù„Ø®Øµ -->
            <section class="card" style="grid-column:1/-1">
                <h2>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ù†Ø©</h2>
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…Ø¤Ø´Ø±</th>
                            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠ</td>
                            <td id="sumYear">â€”</td>
                        </tr>
                        <tr>
                            <td>Ø£Ø¹Ù„Ù‰ Ø´Ù‡Ø± Ø²ÙŠØ§Ø±Ø§Øª</td>
                            <td id="bestMonth">â€”</td>
                        </tr>
                        <tr>
                            <td>Ø£ÙƒØ«Ø± Ù‚Ø³Ù… Ø²ÙŠØ§Ø±Ø©</td>
                            <td id="bestDept">â€”</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- html2canvas + jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <script>
        // Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨ÙÙˆØ§ØµÙ„
        const fmt = n => Number(n).toLocaleString('en');

        // Ø§Ù„ØªØ§Ø±ÙŠØ®
        (function () {
            const today = new Date();
            const opt = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('today').textContent = "ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: " + today.toLocaleDateString('ar-EG', opt);
        })();

        // Ø±ÙˆØ§Ø¨Ø· CSV Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ù…Ù† Google Sheets 
        const SHEET_CSV_MONTHLY = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2-wtcsZJlDXPBL_-WHldwl3HiO2fFCJ5xokezULto8AYpXUIMB8bqPuWsfJSVgpjQHJYDyhm4_RQE/pub?gid=1826260664&single=true&output=csv';
        const SHEET_CSV_DEPT = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2-wtcsZJlDXPBL_-WHldwl3HiO2fFCJ5xokezULto8AYpXUIMB8bqPuWsfJSVgpjQHJYDyhm4_RQE/pub?gid=1243049552&single=true&output=csv';

        window.addEventListener('DOMContentLoaded', () => {
            loadMonthlySmart();
            loadDepartmentsSmart();
        });

        // Helpers
        async function fetchCSV(url) {
            const res = await fetch(url, { cache: 'no-store' });
            const text = await res.text();
            const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
            if (!rows.length) throw new Error('CSV ÙØ§Ø±Øº');
            rows[0][0] = rows[0][0].replace(/^\uFEFF/, '').trim();
            return rows;
        }
        function sum(arr) { return arr.reduce((a, b) => a + b, 0); }

        // 1) Ø§Ù„Ø£Ø´Ù‡Ø±: Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„ÙƒÙ„ Ø´Ù‡Ø± (Ù†ØªØ¬Ø§Ù‡Ù„ "Ø¥Ø¬Ù…Ø§Ù„ÙŠ" Ø¥Ù† ÙˆØ¬Ø¯)
        async function loadMonthlySmart() {
            try {
                const rows = await fetchCSV(SHEET_CSV_MONTHLY);
                const headers = rows[0].map(h => h.trim());
                const idxMonth = headers.findIndex(h => h.includes('Ø§Ù„Ø´Ù‡Ø±') || h.includes('Ø´Ù‡Ø±'));
                if (idxMonth === -1) throw new Error('Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ø´Ù‡Ø±" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ MonthlyVisits');

                const deptCols = headers
                    .map((h, i) => ({ h, i }))
                    .filter(c => c.i !== idxMonth && !/Ø¥Ø¬Ù…Ø§Ù„ÙŠ/i.test(c.h))
                    .map(c => c.i);

                const labels = [], values = [];
                for (let r = 1; r < rows.length; r++) {
                    const month = (rows[r][idxMonth] || '').trim();
                    if (!month) continue;
                    let s = 0;
                    for (const c of deptCols) {
                        const v = parseFloat((rows[r][c] || '0').toString().replace(/[^\d.]/g, '')) || 0;
                        s += v;
                    }
                    labels.push(month);
                    values.push(s);
                }

                const ctx = document.getElementById('monthlyChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Ø²ÙŠØ§Ø±Ø§Øª', data: values }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, title: { display: true, text: 'Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø´Ù‡Ø±ÙŠÙ‹Ø§' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                const total = sum(values);
                document.getElementById('monthlyTotal').textContent = 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠ: ' + fmt(total);
                const maxIdx = values.indexOf(Math.max(...values));
                const sumYearEl = document.getElementById('sumYear');
                const bestMonthEl = document.getElementById('bestMonth');
                if (sumYearEl) sumYearEl.textContent = fmt(total);
                if (bestMonthEl) bestMonthEl.textContent = labels[maxIdx] + ' (' + fmt(values[maxIdx]) + ')';
            } catch (e) {
                console.error(e);
                document.getElementById('monthlyTotal').textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø±. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† CSV ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.';
                const box = document.createElement('div');
                box.className = 'notice';
                box.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø±. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ù†Ø´Ø± Ø§Ù„ÙˆØ±Ù‚Ø© ÙƒÙ€ CSV ÙˆÙ…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.';
                document.querySelector('.page')?.prepend(box);
            }
        }

        // 2) Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ÙŠÙ‚Ø¨Ù„ "Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª" Ø£Ùˆ "Ø§Ù„Ù†Ø³Ø¨Ø©" (Ùª) ÙˆÙŠØ¹Ø¨Ù‘ÙŠ Ø¬Ø¯ÙˆÙ„ deptTable
        async function loadDepartmentsSmart() {
            try {
                const rows = await fetchCSV(SHEET_CSV_DEPT);
                const headers = rows[0].map(h => h.trim());
                const idxDept = headers.findIndex(h => /Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©|Ø§Ù„Ù‚Ø³Ù…/i.test(h));
                let idxVisits = headers.findIndex(h => /Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª/i.test(h));
                let idxPct = headers.findIndex(h => /Ø§Ù„Ù†Ø³Ø¨Ø©/i.test(h));

                if (idxDept === -1 || (idxVisits === -1 && idxPct === -1))
                    throw new Error('ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ÙˆØ¬ÙˆØ¯ "Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©" Ùˆ"Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª" Ø£Ùˆ "Ø§Ù„Ù†Ø³Ø¨Ø©" ÙÙŠ DepartmentShare');

                const labels = [], values = [];
                const isPercent = (idxVisits === -1);

                for (let r = 1; r < rows.length; r++) {
                    const name = (rows[r][idxDept] || '').trim();
                    if (!name) continue;
                    let val = 0;
                    if (!isPercent) {
                        val = parseFloat((rows[r][idxVisits] || '0').toString().replace(/[^\d.]/g, '')) || 0;
                    } else {
                        const raw = (rows[r][idxPct] || '0').toString().replace('%', '').trim();
                        val = parseFloat(raw) || 0; // Ù†Ø³Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
                    }
                    labels.push(name);
                    values.push(val);
                }

                // Ø§Ù„Ø±Ø³Ù…
                const ctx = document.getElementById('deptChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels, datasets: [{ data: values }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' }, title: { display: true, text: (isPercent ? 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ù„ÙƒÙ„ Ù‚Ø³Ù…' : 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ù„ÙƒÙ„ Ù‚Ø³Ù…') } }
                    }
                });

                // Ø£ÙØ¶Ù„ Ù‚Ø³Ù…
                const maxIdx = values.indexOf(Math.max(...values));
                const bestText = labels[maxIdx] + ' (' + (isPercent ? values[maxIdx].toFixed(1) + '%' : fmt(values[maxIdx])) + ')';
                const bestDeptEl = document.getElementById('bestDept');
                const deptTopEl = document.getElementById('deptTop');
                if (bestDeptEl) bestDeptEl.textContent = bestText;
                if (deptTopEl) deptTopEl.textContent = 'Ø£ÙƒØ«Ø± Ù‚Ø³Ù… Ø²ÙŠØ§Ø±Ø©: ' + bestText;

                // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const tbody = document.querySelector('#deptTable tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                    const items = labels.map((name, i) => ({ name, val: values[i] })).sort((a, b) => b.val - a.val);
                    for (const item of items) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${item.name}</td><td>${isPercent ? item.val.toFixed(1) + '%' : fmt(item.val)}</td>`;
                        tbody.appendChild(tr);
                    }
                }
            } catch (e) {
                console.error(e);
                const tbody = document.querySelector('#deptTable tbody');
                if (tbody) { tbody.innerHTML = '<tr><td colspan="2">ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø±Ø§Ø¨Ø· CSV ÙˆØ§Ù„Ø£Ø¹Ù…Ø¯Ø©.</td></tr>'; }
                const el = document.getElementById('deptTop');
                if (el) el.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù….';
                const box = document.createElement('div');
                box.className = 'notice';
                box.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ù†Ø´Ø± Ø§Ù„ÙˆØ±Ù‚Ø© ÙƒÙ€ CSV ÙˆÙ…Ù† Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.';
                document.querySelector('.page')?.prepend(box);
            }
        }

        // PDF
        async function exportPDF(ev) {
            try {
                const btn = ev?.target; if (btn) { btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ PDF...'; }
                document.body.classList.add('capturing');
                await new Promise(r => setTimeout(r, 300));
                const node = document.getElementById('printArea');
                const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#FFFFFF', useCORS: true });
                const img = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageW = 210, pageH = 297, m = 5;
                const imgW = pageW - m * 2;
                const imgH = (canvas.height * imgW) / canvas.width;
                let y = m;
                pdf.addImage(img, 'PNG', m, y, imgW, imgH);
                let left = imgH - (pageH - y - m);
                let pos = y - pageH + m;
                while (left > 0) {
                    pdf.addPage();
                    pos += pageH;
                    pdf.addImage(img, 'PNG', m, -pos, imgW, imgH);
                    left -= pageH;
                }
                pdf.save('stats-yearly.pdf');
            } catch (e) {
                alert('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† logo.jpg ÙˆØ±ÙˆØ§Ø¨Ø· CSV.');
                console.error(e);
            } finally {
                document.body.classList.remove('capturing');
                const btn = ev?.target; if (btn) { btn.disabled = false; btn.textContent = 'â¬‡ PDF'; }
            }
        }
    </script>
</body>

</html>