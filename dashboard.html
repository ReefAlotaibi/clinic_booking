<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم المواعيد والزيارات</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:'Tahoma',sans-serif;direction:rtl;background:#f7f7f7;margin:0}
    header{background:#0066cc;color:#fff;padding:20px;text-align:center}
    .dashboard{display:flex;flex-wrap:wrap;justify-content:space-around;padding:20px}
    .card{background:#fff;box-shadow:0 0 10px rgba(0,0,0,.1);border-radius:10px;margin:10px;padding:20px;flex:1 1 400px;max-width:45%}
    .chart-box{max-width:560px;margin:0 auto}
    canvas{width:100% !important;height:320px !important}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:10px;border:1px solid #ddd;text-align:center;word-break:break-word}
    .alert{padding:10px;background:#ffdddd;border:1px solid #ff5c5c;border-radius:5px;margin-top:10px}
    @media print{
      body{width:210mm;height:297mm;margin:10mm;font-size:12px}
      .dashboard{display:block;width:100%}
      .card{page-break-inside:avoid;width:100% !important;margin-bottom:20px;box-shadow:none}
      table{width:100% !important;table-layout:fixed;word-wrap:break-word;font-size:11px}
      canvas{max-width:100% !important;height:260px !important}
      .no-print,button{display:none !important}
    }
  </style>
</head>
<body>
  <header>
    <h1>لوحة تحكم المواعيد والزيارات - مجمع أطلس الطبي </h1>
    <p id="today-date" style="margin:5px;font-size:18px;"></p>
    <div class="no-print" style="text-align:right;padding:10px 20px;">
      <button onclick="window.print()" style="padding:8px 16px;font-size:15px;">🖨 طباعة</button>
    </div>
  </header>

  <div class="dashboard">
    <!-- أوقات الذروة (ثابت) -->
    <div class="card">
      <h2>أوقات الذروة حسب الساعة</h2>
      <div class="chart-box">
        <canvas id="peakChart"></canvas>
      </div>
    </div>

    <!-- المواعيد القادمة (ثابت) -->
    <div class="card">
      <h2>المواعيد القادمة</h2>
      <table>
        <thead><tr><th>الطبيب</th><th>التخصص</th><th>الوقت</th></tr></thead>
        <tbody>
          <tr><td>د. فيفي عباس</td><td>جلدية</td><td>5:00 مساءً</td></tr>
          <tr><td>د. قمر الرفاعي</td><td>أسنان عام</td><td>10:00 صباحًا</td></tr>
          <tr><td>د.  أحمد عمار</td><td>تقويم</td><td>3:00 مساءً</td></tr>
        </tbody>
      </table>
    </div>

    <!-- تنبيهات (ثابت) -->
    <div class="card">
      <h2>تنبيهات الزحام</h2>
      <div class="alert">⚠ الزحمة تبدأ من الساعة 4م حتى 9م.</div>
      <div class="alert">⚠ عيادة التقويم ممتلئة يومي السبت والثلاثاء.</div>
      <div class="alert">✅ الساعة 12م إلى 3م أقل وقت ازدحام.</div>
    </div>

    <!-- عدد الزيارات (ديناميكي من Google Sheets) -->
    <div class="card">
      <h2>عدد زيارات العيادات خلال الأسبوع (Google Sheets)</h2>
      <div class="chart-box">
        <canvas id="visitsChart"></canvas>
      </div>
      <p id="totalVisits" style="text-align:center;font-size:16px;margin-top:10px;"></p>
      <p style="text-align:center;font-size:13px;color:gray;">🔄 يتحدث تلقائيًا من Google Sheets</p>
    </div>
  </div>

  <script>


// التاريخ
    (function(){
      const today = new Date();
      const opt = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      document.getElementById('today-date').textContent =
        "📅 التاريخ اليوم: " + today.toLocaleDateString('ar-EG', opt);
    })();

    // أوقات الذروة (ثابت)
    (function(){
      const ctx = document.getElementById('peakChart').getContext('2d');
      const labels = ['9 ص','10 ص','11 ص','12 ظ','1 م','2 م','3 م','4 م','5 م','6 م','7 م','8 م','9 م'];
      const vals   = [3,6,4,3,5,6,8,10,12,11,9,7,4];
      const colors = vals.map(v => v>=10 ? '#cc0000' : v>=6 ? '#ffa500' : '#28a745');
      new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'عدد الحجوزات', data:vals, backgroundColor:colors }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, title:{display:true, text:'عدد المواعيد حسب الساعة'} },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    })();

    // ==== الزيارات من Google Sheets (DashboardData CSV) ====
    const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2-wtcsZJlDXPBL_-WHldwl3HiO2fFCJ5xokezULto8AYpXUIMB8bqPuWsfJSVgpjQHJYDyhm4_RQE/pub?gid=1442116717&single=true&output=csv';

    window.addEventListener('DOMContentLoaded', loadVisits);

    async function loadVisits(){
      try{
        const res  = await fetch(sheetCSV, { cache:'no-store' });
        const text = await res.text();

        const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
        if(!rows.length) throw new Error('CSV فارغ');
        rows[0][0] = rows[0][0].replace(/^\uFEFF/, '').trim();
        const headers = rows[0].map(h => h.trim());

        const idxClinic = headers.findIndex(h => h.includes('العيادة'));
        const idxVisits = headers.findIndex(h => h.includes('زيارات') || h.toLowerCase().includes('sum'));
        if(idxClinic === -1 || idxVisits === -1) throw new Error('لم يتم العثور على الأعمدة: العيادة / الزيارات');

        const labs = [], vals = [];
        for(let i=1;i<rows.length;i++){
          const c = (rows[i][idxClinic] || '').trim();
          const v = parseFloat((rows[i][idxVisits] || '0').toString().replace(/[^\d.]/g,'')) || 0;
          if(c){ labs.push(c); vals.push(v); }
        }

        const vctx = document.getElementById('visitsChart').getContext('2d');
        new Chart(vctx,{
          type:'bar',
          data:{ labels:labs, datasets:[{ label:'عدد الزيارات', data:vals, backgroundColor:'#4caf50' }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false}, title:{display:true, text:'عدد زيارات العيادات (آخر 7 أيام)'} },
            scales:{ y:{ beginAtZero:true } }
          }
        });

        const total = vals.reduce((a,b)=>a+b,0);
        document.getElementById('totalVisits').innerHTML =
          '🔢 <strong>إجمالي زيارات المستشفى هذا الأسبوع:</strong> ' + total + ' زيارة';
      }catch(e){
        console.error(e);
        const el = document.getElementById('totalVisits');
        if(el) el.textContent = 'تعذّر تحميل البيانات. تأكدي من رابط CSV وعناوين الأعمدة في DashboardData.';
      }
    }
  </script>
</body>
</html>
