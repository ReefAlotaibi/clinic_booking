<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø²ÙŠØ§Ø±Ø§Øª </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --brand:#0066cc;
      --text:#222;
      --card:#ffffff;
      --muted:#666;
      --success:#28a745;
      --warn:#ffa500;
      --danger:#cc0000;
      --border:#e6e6e6;
    }
    *{ box-sizing:border-box }

    body{
      font-family: Tahoma, sans-serif;
      direction: rtl;
      background: #f7f7f793;
      color: var(--text);
      margin: 0;
    }

    /* ===== Header ===== */
    header{
      background: var(--card);              
      border-bottom: 1px solid var(--border);
    }
    .topbar{
      max-width: 1200px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; padding: 14px 20px;
    }
    .brand{
      display: flex; align-items: center; gap: 12px;
    }
    .brand img{
      width: 80px; height: 80px; object-fit: contain; border-radius: 8px;
    }
    .brand h1{
      margin: 0;
      font-size: 30px;                     
      color: var(--brand);
      font-weight: bold;
    }
    .meta{ text-align: left; flex: 1; }
    #today-date{ margin: 0; font-size: 16px; color: var(--muted); }

    .actions{ display:flex; gap:8px; }
    .btn{
      padding:9px 14px; border:none; border-radius:8px;
      background:var(--brand); color:#fff; cursor:pointer; font-size:14px;
    }
    .btn.secondary{ background:#12a150; }
    .btn:disabled{ opacity:.7; cursor:not-allowed }

    /* ===== Layout ===== */
    .dashboard{
      display:grid;
      grid-template-columns: repeat(2, minmax(360px, 1fr));
      gap:20px; padding:20px;
      max-width:1200px; margin:0 auto;
    }
    @media (max-width: 820px){
      .dashboard{ grid-template-columns: 1fr; }
      .meta{ display:none; }  
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:0 4px 16px rgba(0,0,0,.05);
      border-radius:12px;
      padding:18px 18px 14px;
    }
    .card h2{
      margin:0 0 10px; font-size:18px; color:var(--brand);
      display:flex; align-items:center; gap:8px;
    }
    .chart-box{ max-width:560px; margin:0 auto; }
    canvas{ width:100% !important; height:320px !important; }

    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th,td{ padding:10px; border:1px solid var(--border); text-align:center; word-break:break-word; }
    thead th{ background:#f3f6fb; color:#333; }

    .alert{
      padding:10px 12px; background:#ffe8e8; border:1px solid #ffb3b3;
      border-radius:8px; margin-top:10px; color:#8b0000; display:flex; align-items:center; gap:8px;
    }
    .alert.ok{ background:#eaf7ee; border-color:#bfe5ca; color:#116a2b; }

    /* Ù†Ø®ÙÙŠ Ø¹Ù†Ø§ØµØ± Ù…Ø¹ÙŠÙ†Ø© ÙˆÙ‚Øª Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø· */
    .capturing .no-print{ display:none !important; }

    /* ===== Ø·Ø¨Ø§Ø¹Ø© A4 ===== */
    @media print{
      body{
        width:210mm; height:297mm; margin:10mm;
        font-size:12px; background:#fff;
      }
      header{
        background:#fff !important; color:#000 !important;
        border-bottom:1px solid #ccc;
      }
      .brand h1{ color:#000 !important; }
      #today-date{ color:#000 !important; font-size:14px !important; }

      .dashboard{ display:block; width:100%; }
      .card{ page-break-inside:avoid; width:100% !important; margin-bottom:14px; box-shadow:none; }
      table{ font-size:11px; }
      canvas{ height:260px !important; }
      .no-print, button{ display:none !important; }
    }
  </style>
</head>
<body>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„ØªØµØ¯ÙŠØ± -->
  <div id="printArea">
    <header>
      <div class="topbar">
        <div class="brand">
          <img src="logo.jpg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰">
          <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h1>
        </div>
        <div class="meta">
          <p id="today-date"></p>
        </div>
        <div class="actions no-print">
          <button class="btn" onclick="window.print()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn secondary" onclick="exportPDF(event)">â¬‡ PDF</button>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <!-- Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ© -->
      <section class="card">
        <h2>â° Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©</h2>
        <div class="chart-box"><canvas id="peakChart"></canvas></div>
      </section>

      <!-- Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© -->
      <section class="card">
        <h2>ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h2>
        <table>
          <thead>
            <tr><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„ØªØ®ØµØµ</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr>
          </thead>
          <tbody>
            <tr><td>Ø¯. ÙÙŠÙÙŠ Ø¹Ø¨Ø§Ø³</td><td>Ø¬Ù„Ø¯ÙŠØ©</td><td>5:00 Ù…Ø³Ø§Ø¡Ù‹</td></tr>
            <tr><td>Ø¯. Ù‚Ù…Ø± Ø§Ù„Ø±ÙØ§Ø¹ÙŠ</td><td>Ø£Ø³Ù†Ø§Ù† Ø¹Ø§Ù…</td><td>10:00 ØµØ¨Ø§Ø­Ù‹Ø§</td></tr>
            <tr><td>Ø¯. Ø£Ø­Ù…Ø¯ Ø¹Ù…Ø§Ø±</td><td>ØªÙ‚ÙˆÙŠÙ…</td><td>3:00 Ù…Ø³Ø§Ø¡Ù‹</td></tr>
          </tbody>
        </table>
      </section>

      <!-- ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
      <section class="card">
        <h2>âš  ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø²Ø­Ø§Ù…</h2>
        <div class="alert">âš  Ø§Ù„Ø²Ø­Ù…Ø© ØªØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 4Ù… Ø­ØªÙ‰ 9Ù….</div>
        <div class="alert">âš  Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ù…Ù…ØªÙ„Ø¦Ø© ÙŠÙˆÙ…ÙŠ Ø§Ù„Ø³Ø¨Øª ÙˆØ§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡.</div>
        <div class="alert ok">âœ… Ø§Ù„Ø³Ø§Ø¹Ø© 12Ù… Ø¥Ù„Ù‰ 3Ù… Ø£Ù‚Ù„ ÙˆÙ‚Øª Ø§Ø²Ø¯Ø­Ø§Ù….</div>
      </section>

      <!-- Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ -->
      <section class="card">
        <h2>ğŸ“ˆ Ø¹Ø¯Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Google Sheets)</h2>
        <div class="chart-box"><canvas id="visitsChart"></canvas></div>
        <p id="totalVisits" style="text-align:center; font-size:16px; margin-top:10px;"></p>
        <p style="text-align:center; font-size:12px; color:#888;">ğŸ”„ ÙŠØªØ­Ø¯Ù‘Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Google Sheets</p>
      </section>
    </main>
  </div>

  <script>

    // Ø§Ù„ØªØ§Ø±ÙŠØ®
    (function(){
      const today = new Date(); // Ø£Ùˆ Ø§ÙƒØªØ¨ÙŠ ØªØ§Ø±ÙŠØ® Ø«Ø§Ø¨Øª new Date('2025-08-10')
      const opt = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      document.getElementById('today-date').textContent =
        "ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: " + today.toLocaleDateString('ar-EG', opt);
    })();

    // Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ© (Ø«Ø§Ø¨Øª)
    (function(){
      const ctx = document.getElementById('peakChart').getContext('2d');
      const labels = ['9 Øµ','10 Øµ','11 Øµ','12 Ø¸','1 Ù…','2 Ù…','3 Ù…','4 Ù…','5 Ù…','6 Ù…','7 Ù…','8 Ù…','9 Ù…'];
      const vals   = [3,6,4,3,5,6,8,10,12,11,9,7,4];
      const colors = vals.map(v => v>=10 ? '#cc0000' : v>=6 ? '#ffa500' : '#28a745');
      new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª', data:vals, backgroundColor:colors }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, title:{display:true, text:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø©'} },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    })();

    // ==== Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ù…Ù† Google Sheets (DashboardData CSV) ====
    const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2-wtcsZJlDXPBL_-WHldwl3HiO2fFCJ5xokezULto8AYpXUIMB8bqPuWsfJSVgpjQHJYDyhm4_RQE/pub?gid=1442116717&single=true&output=csv';

    window.addEventListener('DOMContentLoaded', loadVisits);

    async function loadVisits(){
      try{
        const res  = await fetch(sheetCSV, { cache:'no-store' });
        const text = await res.text();

        const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
        if(!rows.length) throw new Error('CSV ÙØ§Ø±Øº');
        rows[0][0] = rows[0][0].replace(/^\uFEFF/, '').trim();
        const headers = rows[0].map(h => h.trim());

        const idxClinic = headers.findIndex(h => h.includes('Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©'));
        const idxVisits = headers.findIndex(h => h.includes('Ø²ÙŠØ§Ø±Ø§Øª') || h.toLowerCase().includes('sum'));
        if(idxClinic === -1 || idxVisits === -1) throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª');

        const labs = [], vals = [];
        for(let i=1;i<rows.length;i++){
          const c = (rows[i][idxClinic] || '').trim();
          const v = parseFloat((rows[i][idxVisits] || '0').toString().replace(/[^\d.]/g,'')) || 0;
          if(c){ labs.push(c); vals.push(v); }
        }

        const vctx = document.getElementById('visitsChart').getContext('2d');
        new Chart(vctx,{
          type:'bar',
          data:{ labels:labs, datasets:[{ label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª', data:vals, backgroundColor:'#4caf50' }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false}, title:{display:true, text:'Ø¹Ø¯Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)'} },
            scales:{ y:{ beginAtZero:true } }
          }
        });

        const total = vals.reduce((a,b)=>a+b,0);
        document.getElementById('totalVisits').innerHTML =
          ' <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</strong> ' + total + ' Ø²ÙŠØ§Ø±Ø©';
      }catch(e){
        console.error(e);
        const el = document.getElementById('totalVisits');
        if(el) el.textContent = 'ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø±Ø§Ø¨Ø· CSV ÙˆØ¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ DashboardData.';
      }
    }
  </script>

  <!-- Ù…ÙƒØªØ¨Ø§Øª PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ØªØµØ¯ÙŠØ± Ø§Ù„Ù‡ÙŠØ¯Ø± + Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¥Ù„Ù‰ PDF
    async function exportPDF(ev){
      try{
        const btn = ev?.target;
        if (btn) { btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ PDF...'; }

        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± .no-print Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
        document.body.classList.add('capturing');

        // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø±Ø³ÙˆÙ…
        await new Promise(r => setTimeout(r, 300));

        const node = document.getElementById('printArea');
        const canvas = await html2canvas(node, { scale:2, backgroundColor:'#FFFFFF', useCORS:true });
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p','mm','a4');
        const pageWidth = 210, pageHeight = 297, margin = 5;
        const imgWidth = pageWidth - margin*2;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let y = margin;
        pdf.addImage(imgData,'PNG', margin, y, imgWidth, imgHeight);

        // ØµÙØ­Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
        let heightLeft = imgHeight - (pageHeight - y - margin);
        let position = y - pageHeight + margin;
        while(heightLeft > 0){
          pdf.addPage();
          position += pageHeight;
          pdf.addImage(imgData,'PNG', margin, -position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save('dashboard.pdf');
      }catch(err){
        console.error(err);
        alert('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ÙˆØ¬ÙˆØ¯ logo.jpg Ùˆ #printArea.');
      }finally{
        document.body.classList.remove('capturing');
        const btn = ev?.target;
        if (btn) { btn.disabled = false; btn.textContent = 'â¬‡ PDF'; }
      }
    }
  </script>
</body>
</html>
