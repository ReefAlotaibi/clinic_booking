<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم المواعيد والزيارات </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --brand:#0066cc;
      --text:#222;
      --card:#ffffff;
      --muted:#666;
      --success:#28a745;
      --warn:#ffa500;
      --danger:#cc0000;
      --border:#e6e6e6;
    }
    *{ box-sizing:border-box }

    body{
      font-family: Tahoma, sans-serif;
      direction: rtl;
      background: #f7f7f793;
      color: var(--text);
      margin: 0;
    }

    /* ===== Header ===== */
    header{
      background: var(--card);              
      border-bottom: 1px solid var(--border);
    }
    .topbar{
      max-width: 1200px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; padding: 14px 20px;
    }
    .brand{
      display: flex; align-items: center; gap: 12px;
    }
    .brand img{
      width: 80px; height: 80px; object-fit: contain; border-radius: 8px;
    }
    .brand h1{
      margin: 0;
      font-size: 30px;                     
      color: var(--brand);
      font-weight: bold;
    }
    .meta{ text-align: left; flex: 1; }
    #today-date{ margin: 0; font-size: 16px; color: var(--muted); }

    .actions{ display:flex; gap:8px; }
    .btn{
      padding:9px 14px; border:none; border-radius:8px;
      background:var(--brand); color:#fff; cursor:pointer; font-size:14px;
    }
    .btn.secondary{ background:#12a150; }
    .btn:disabled{ opacity:.7; cursor:not-allowed }

    /* ===== Layout ===== */
    .dashboard{
      display:grid;
      grid-template-columns: repeat(2, minmax(360px, 1fr));
      gap:20px; padding:20px;
      max-width:1200px; margin:0 auto;
    }
    @media (max-width: 820px){
      .dashboard{ grid-template-columns: 1fr; }
      .meta{ display:none; }  
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      box-shadow:0 4px 16px rgba(0,0,0,.05);
      border-radius:12px;
      padding:18px 18px 14px;
    }
    .card h2{
      margin:0 0 10px; font-size:18px; color:var(--brand);
      display:flex; align-items:center; gap:8px;
    }
    .chart-box{ max-width:560px; margin:0 auto; }
    canvas{ width:100% !important; height:320px !important; }

    table{ width:100%; border-collapse:collapse; table-layout:fixed; }
    th,td{ padding:10px; border:1px solid var(--border); text-align:center; word-break:break-word; }
    thead th{ background:#f3f6fb; color:#333; }

    .alert{
      padding:10px 12px; background:#ffe8e8; border:1px solid #ffb3b3;
      border-radius:8px; margin-top:10px; color:#8b0000; display:flex; align-items:center; gap:8px;
    }
    .alert.ok{ background:#eaf7ee; border-color:#bfe5ca; color:#116a2b; }

    /* نخفي عناصر معينة وقت الالتقاط */
    .capturing .no-print{ display:none !important; }

    /* ===== طباعة A4 ===== */
    @media print{
      body{
        width:210mm; height:297mm; margin:10mm;
        font-size:12px; background:#fff;
      }
      header{
        background:#fff !important; color:#000 !important;
        border-bottom:1px solid #ccc;
      }
      .brand h1{ color:#000 !important; }
      #today-date{ color:#000 !important; font-size:14px !important; }

      .dashboard{ display:block; width:100%; }
      .card{ page-break-inside:avoid; width:100% !important; margin-bottom:14px; box-shadow:none; }
      table{ font-size:11px; }
      canvas{ height:260px !important; }
      .no-print, button{ display:none !important; }
    }
  </style>
</head>
<body>

  <!-- منطقة الطباعة/التصدير -->
  <div id="printArea">
    <header>
      <div class="topbar">
        <div class="brand">
          <img src="logo.jpg" alt="شعار المستشفى">
          <h1>لوحة تحكم المواعيد والزيارات</h1>
        </div>
        <div class="meta">
          <p id="today-date"></p>
        </div>
        <div class="actions no-print">
          <button class="btn" onclick="window.print()">🖨 طباعة</button>
          <button class="btn secondary" onclick="exportPDF(event)">⬇ PDF</button>
        </div>
      </div>
    </header>

    <main class="dashboard">
      <!-- أوقات الذروة -->
      <section class="card">
        <h2>⏰ أوقات الذروة حسب الساعة</h2>
        <div class="chart-box"><canvas id="peakChart"></canvas></div>
      </section>

      <!-- المواعيد القادمة -->
      <section class="card">
        <h2>📅 المواعيد القادمة</h2>
        <table>
          <thead>
            <tr><th>الطبيب</th><th>التخصص</th><th>الوقت</th></tr>
          </thead>
          <tbody>
            <tr><td>د. فيفي عباس</td><td>جلدية</td><td>5:00 مساءً</td></tr>
            <tr><td>د. قمر الرفاعي</td><td>أسنان عام</td><td>10:00 صباحًا</td></tr>
            <tr><td>د. أحمد عمار</td><td>تقويم</td><td>3:00 مساءً</td></tr>
          </tbody>
        </table>
      </section>

      <!-- تنبيهات -->
      <section class="card">
        <h2>⚠ تنبيهات الزحام</h2>
        <div class="alert">⚠ الزحمة تبدأ من الساعة 4م حتى 9م.</div>
        <div class="alert">⚠ عيادة التقويم ممتلئة يومي السبت والثلاثاء.</div>
        <div class="alert ok">✅ الساعة 12م إلى 3م أقل وقت ازدحام.</div>
      </section>

      <!-- زيارات الأسبوع -->
      <section class="card">
        <h2>📈 عدد زيارات العيادات خلال الأسبوع (Google Sheets)</h2>
        <div class="chart-box"><canvas id="visitsChart"></canvas></div>
        <p id="totalVisits" style="text-align:center; font-size:16px; margin-top:10px;"></p>
        <p style="text-align:center; font-size:12px; color:#888;">🔄 يتحدّث تلقائيًا من Google Sheets</p>
      </section>
    </main>
  </div>

  <script>

    // التاريخ
    (function(){
      const today = new Date(); // أو اكتبي تاريخ ثابت new Date('2025-08-10')
      const opt = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
      document.getElementById('today-date').textContent =
        "📅 التاريخ: " + today.toLocaleDateString('ar-EG', opt);
    })();

    // أوقات الذروة (ثابت)
    (function(){
      const ctx = document.getElementById('peakChart').getContext('2d');
      const labels = ['9 ص','10 ص','11 ص','12 ظ','1 م','2 م','3 م','4 م','5 م','6 م','7 م','8 م','9 م'];
      const vals   = [3,6,4,3,5,6,8,10,12,11,9,7,4];
      const colors = vals.map(v => v>=10 ? '#cc0000' : v>=6 ? '#ffa500' : '#28a745');
      new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'عدد الحجوزات', data:vals, backgroundColor:colors }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, title:{display:true, text:'عدد المواعيد حسب الساعة'} },
          scales:{ y:{ beginAtZero:true } }
        }
      });
    })();

    // ==== الزيارات من Google Sheets (DashboardData CSV) ====
    const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2-wtcsZJlDXPBL_-WHldwl3HiO2fFCJ5xokezULto8AYpXUIMB8bqPuWsfJSVgpjQHJYDyhm4_RQE/pub?gid=1442116717&single=true&output=csv';

    window.addEventListener('DOMContentLoaded', loadVisits);

    async function loadVisits(){
      try{
        const res  = await fetch(sheetCSV, { cache:'no-store' });
        const text = await res.text();

        const rows = text.trim().split(/\r?\n/).map(r => r.split(','));
        if(!rows.length) throw new Error('CSV فارغ');
        rows[0][0] = rows[0][0].replace(/^\uFEFF/, '').trim();
        const headers = rows[0].map(h => h.trim());

        const idxClinic = headers.findIndex(h => h.includes('العيادة'));
        const idxVisits = headers.findIndex(h => h.includes('زيارات') || h.toLowerCase().includes('sum'));
        if(idxClinic === -1 || idxVisits === -1) throw new Error('لم يتم العثور على الأعمدة: العيادة / الزيارات');

        const labs = [], vals = [];
        for(let i=1;i<rows.length;i++){
          const c = (rows[i][idxClinic] || '').trim();
          const v = parseFloat((rows[i][idxVisits] || '0').toString().replace(/[^\d.]/g,'')) || 0;
          if(c){ labs.push(c); vals.push(v); }
        }

        const vctx = document.getElementById('visitsChart').getContext('2d');
        new Chart(vctx,{
          type:'bar',
          data:{ labels:labs, datasets:[{ label:'عدد الزيارات', data:vals, backgroundColor:'#4caf50' }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{display:false}, title:{display:true, text:'عدد زيارات العيادات (آخر 7 أيام)'} },
            scales:{ y:{ beginAtZero:true } }
          }
        });

        const total = vals.reduce((a,b)=>a+b,0);
        document.getElementById('totalVisits').innerHTML =
          ' <strong>إجمالي زيارات المستشفى هذا الأسبوع:</strong> ' + total + ' زيارة';
      }catch(e){
        console.error(e);
        const el = document.getElementById('totalVisits');
        if(el) el.textContent = 'تعذّر تحميل البيانات. تأكدي من رابط CSV وعناوين الأعمدة في DashboardData.';
      }
    }
  </script>

  <!-- مكتبات PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // تصدير الهيدر + الداشبورد إلى PDF
    async function exportPDF(ev){
      try{
        const btn = ev?.target;
        if (btn) { btn.disabled = true; btn.textContent = 'جارٍ إنشاء PDF...'; }

        // إخفاء عناصر .no-print أثناء الالتقاط
        document.body.classList.add('capturing');

        // انتظر قليلًا لتثبيت الرسوم
        await new Promise(r => setTimeout(r, 300));

        const node = document.getElementById('printArea');
        const canvas = await html2canvas(node, { scale:2, backgroundColor:'#FFFFFF', useCORS:true });
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p','mm','a4');
        const pageWidth = 210, pageHeight = 297, margin = 5;
        const imgWidth = pageWidth - margin*2;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let y = margin;
        pdf.addImage(imgData,'PNG', margin, y, imgWidth, imgHeight);

        // صفحات إضافية عند الحاجة
        let heightLeft = imgHeight - (pageHeight - y - margin);
        let position = y - pageHeight + margin;
        while(heightLeft > 0){
          pdf.addPage();
          position += pageHeight;
          pdf.addImage(imgData,'PNG', margin, -position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save('dashboard.pdf');
      }catch(err){
        console.error(err);
        alert('تعذّر إنشاء PDF. تأكدي من وجود logo.jpg و #printArea.');
      }finally{
        document.body.classList.remove('capturing');
        const btn = ev?.target;
        if (btn) { btn.disabled = false; btn.textContent = '⬇ PDF'; }
      }
    }
  </script>
</body>
</html>
